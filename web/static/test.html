<!DOCTYPE html>
<html>
  <head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
	<meta name="renderer" content="webkit|ie-comp|ie-stand">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta http-equiv="Cache-Control" content="no-siteapp" />
    <title>爱立信系统监控</title>
	<link href="image/favicon.ico" rel="shortcut icon">
	<link rel="stylesheet" href="css/sccl.css">
	<link rel="stylesheet" href="css/skin.css">
      <style>
          .folder {
              background: #eee;
          }

          .folder-title {
              cursor: pointer;
              background: #bbb;
              padding: 10px;
              font-size: 18px;
          }

          .folder-main {
              padding: 10px;
          }
      </style>
  </head>
  <body>
  <div id="hosts"></div>
  <div id="red"></div>
  <div id="yellow"></div>
  </body>
  <script src="insdep/jquery.min.js"></script>
  <script src="insdep/san.dev.js"></script>
  <script>
      var count=0;
      var model = {
          "hosts":[],
          "details":[],
          "lights": {
              "red":{},
              "yellow":{}
          }
      }

      var Hosts = san.defineComponent({
          template: '<d><dt>{{count}}</dt>'
                        +'<dl san-for="h in hosts" title="hh{{h}}">Host:{{h}}</dl></d>',
          attached: function() {
              if (model != undefined && "hosts" in model) {
                  this.data.set('hosts', model.hosts)
                  this.data.set('count', count)
              }

          }
      })

      var RedLightZone = san.defineComponent({
          template: '<d><dt>RED_Light</dt>'
                    +'<dl san-for="l in rk" title="{{l}}">RED:{{rl[l].name}}</dl></d>',
          attached: function () {
              if (model != undefined && "lights" in model) {
                  var lights = model.lights;
                  if (lights != undefined && "red" in lights) {
                      this.data.set('rk', Object.keys(lights.red))
                      this.data.set('rl', lights.red)
                  }
              }
          }
      });

      var YellowLightZone = san.defineComponent({
          template: '<d><dt>Yellow_Light</dt>'
          +'<dl san-for="l in rk" title="{{l}}">RED:{{rl[l].name}}</dl></d>',
          attached: function () {
              if (model != undefined && "lights" in model) {
                  var lights = model.lights;
                  if (lights != undefined && "yellow" in lights) {
                      this.data.set('rk', Object.keys(lights.yellow))
                      this.data.set('rl', lights.yellow)
                  }
              }
          }
      });

      var redLightZone = new RedLightZone();
      var hosts = new Hosts();
      var yellowLightZone= new YellowLightZone();

      /*循环更新model*/
      var INTERVAL = 5000
      var tt = null;
      function requestLoop() {
          $.ajax({
              type : "GET",
              url :"getSummary?detail=1",
              dataType: "json",
              success : function(data) {
                  count+=1
                  model = data
                  hosts.detach(document.body.children.hosts)
                  hosts.attach(document.body.children.hosts)
                  yellowLightZone.detach(document.body.children.yellow)
                  yellowLightZone.attach(document.body.children.yellow)
                  redLightZone.detach(document.body.children.red)
                  redLightZone.attach(document.body.children.red)
                  tt = setTimeout(requestLoop, INTERVAL);
              },
              error : function(xhr,textStatus,errorThrown){
                  if (xhr.status == 401) {
                      if (tt != null) {
                          clearTimeout(tt);
                          tt = null;
                      }
                  }
              }
          })
      }
      requestLoop();


  </script>
</html>
